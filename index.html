<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Glow Toy</title>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: 2rem auto; }
    #chat { border: 1px solid #ccc; padding: 1rem; height: 300px; overflow-y: auto; white-space: pre-wrap; }
    .user { font-weight: bold; margin-top: 0.5rem; }
    .assistant { margin-top: 0.5rem; }
  </style>
</head>
<body>
  <h1>Glow Toy Chat</h1>
  <div id="chat"></div>
  <div style="margin-top:1rem;">
    <input id="prompt" type="text" placeholder="Say somethingâ€¦" style="width:75%;" />
    <button id="send">Send</button>
  </div>

  <script>
    const chatEl = document.getElementById("chat");
    const promptEl = document.getElementById("prompt");
    const sendBtn = document.getElementById("send");

    let messages = [];

    function append(role, text) {
      const div = document.createElement("div");
      div.className = role;
      div.textContent = (role === "user" ? "You: " : "AI: ") + text;
      chatEl.appendChild(div);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    sendBtn.onclick = async () => {
      const text = promptEl.value.trim();
      if (!text) return;
      promptEl.value = "";
      append("user", text);
      messages.push({ role: "user", content: text });

      try {
        const resp = await fetch("/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            model: "gpt-4o-mini",
            messages: messages,
            temperature: 0.7
          })
        });

        const reader = resp.body.getReader();
        const decoder = new TextDecoder("utf-8");
        let buffer = "";
        let aiText = "";

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          buffer += decoder.decode(value, { stream: true });

          const parts = buffer.split("\n\n");
          buffer = parts.pop();

          for (const part of parts) {
            if (part.startsWith("data: ")) {
              const data = part.replace("data: ", "").trim();
              if (data === "[DONE]") continue;
              try {
                const json = JSON.parse(data);
                const delta = json.choices[0].delta?.content;
                if (delta) {
                  aiText += delta;
                  if (!document.getElementById("streaming")) {
                    const div = document.createElement("div");
                    div.id = "streaming";
                    div.className = "assistant";
                    div.textContent = "AI: ";
                    chatEl.appendChild(div);
                  }
                  document.getElementById("streaming").textContent = "AI: " + aiText;
                  chatEl.scrollTop = chatEl.scrollHeight;
                }
              } catch {}
            }
          }
        }

        // finalize
        if (aiText) {
          document.getElementById("streaming").removeAttribute("id");
          messages.push({ role: "assistant", content: aiText });
        }
      } catch (err) {
        console.error("Error:", err);
        append("assistant", "[error]");
      }
    };
  </script>
</body>
</html>
